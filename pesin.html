<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Peşin Satış</title>
<style>
:root{
--tkk-green:#1A6B3B;--tkk-orange:#FF9800;--tkk-red:#E53935;
--tkk-white:#fff;--tkk-gray:#f5f5f5;--border:#ddd;
}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--tkk-gray);margin:0}
.container{padding:10px}
.panel{background:var(--tkk-white);border-radius:10px;box-shadow:0 0 4px rgba(0,0,0,.1);padding:15px;margin:10px;flex:1}
.panels-row{display:flex;flex-wrap:wrap;gap:10px}
h3{color:var(--tkk-green);border-bottom:2px solid var(--tkk-green);padding-bottom:4px;margin-bottom:10px}
.form-control{border:1px solid var(--border);padding:5px;border-radius:6px;width:100%;box-sizing:border-box}
.para-sayi-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:6px}
.duzeltme-grid{display:grid;grid-template-columns:3fr 1fr;gap:6px;margin-bottom:6px}
.duzeltme-sum-grid{display:grid;grid-template-columns:3fr 1fr;gap:6px;margin-top:10px}
.satis-item-row{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr 40px;gap:6px;align-items:center;margin-bottom:6px}
.btn-remove-row{background:var(--tkk-red);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:700}
.add-row-btn{color:var(--tkk-green);cursor:pointer;font-weight:700}
.kasa-durum-aciklama{padding:6px;color:#fff;border-radius:6px;margin-top:6px;text-align:center;font-weight:700}
.kasa-tam{background:#2E8B57}.kasa-eksik{background:#E53935}.kasa-fazla{background:#FF9800}
.btn{border:none;border-radius:8px;color:#fff;font-size:16px;font-weight:700;padding:10px 26px;cursor:pointer;transition:.2s}
.btn:hover{opacity:.9}
.btn-orange{background:var(--tkk-orange)}.btn-green{background:var(--tkk-green)}
.buttons{display:flex;justify-content:center;gap:16px;margin-top:14px}
</style>
</head>
<body>
<div class="container">

  <div class="panels-row">
    <!-- PARA SAYILARI -->
    <div class="panel">
      <h3>Para Sayıları</h3>
      <div id="paraSayiContainer"></div>
      <div class="duzeltme-sum-grid">
        <label>TOPLAM</label><input id="paraSayilariToplam" class="form-control" readonly>
      </div>
    </div>

    <!-- KASA DURUMU -->
    <div class="panel">
      <h3>Kasa Durumu</h3>
      <label>Nakit Satış Toplamı</label>
      <input id="nakitSatisKasaDurumu" class="form-control" readonly>
      <label>Kasa Toplamı</label>
      <input id="kasaToplami" class="form-control" readonly>
      <label>Kasa Bakiyesi</label>
      <input id="kasaBakiyesi" class="form-control">
      <label>Durum</label>
      <input id="kasaDurum" class="form-control" readonly>
      <label>Açıklama</label>
      <div id="kasaDurumAciklama" class="kasa-durum-aciklama kasa-tam">Kasa tam.</div>
      <div class="buttons">
        <button class="btn btn-orange" onclick="window.print()">Yazdır</button>
        <button class="btn btn-green" onclick="saveAll()">Kaydet</button>
      </div>
    </div>

    <!-- DÜZELTME KAYITLARI -->
    <div class="panel">
      <h3>Düzeltme Kayıtları</h3>
      <div id="duzeltmeContainer"></div>
      <div class="duzeltme-sum-grid">
        <label>Düzeltme Kayıtları Toplamı</label>
        <input id="duzeltmeKayitlariToplam" class="form-control" readonly>
      </div>
      <div class="duzeltme-sum-grid">
        <label>Nakit Satış Toplamı</label>
        <input id="nakitSatisToplamiDuz" class="form-control" readonly>
      </div>
    </div>
  </div>

  <!-- SATIŞ KAYITLARI -->
  <div class="panel" style="margin-top:12px;">
    <h3>Satış Kayıtları <span id="btnAddSatisRow" class="add-row-btn">+ Satır Ekle</span></h3>
    <div id="satisKayitlariContainer"></div>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzY7jYafKU-DuUBUqq6vj89_sLKSbCmT8c-Fen77HnxB1h7Ji7HzCZmKH8LQMZCz-04/exec";
const $=id=>document.getElementById(id);
const fmt=n=>(Number(n)||0).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2});
const parseTR=s=>{
 if(!s)return 0;
 const str=s.toString().replace(/\./g,"").replace(",",".");
 return parseFloat(str)||0;
};
let STOCK_CODES=[],STOCK_NAMES=[],CODE_TO_NAME={},NAME_TO_CODE={},priceTimer=null;

async function loadAll(){
  const s=await fetch(`${API}?action=getStockLists`).then(r=>r.json()).catch(()=>({}));
  STOCK_CODES=s.codes||[];STOCK_NAMES=s.names||[];
  STOCK_CODES.forEach((c,i)=>{CODE_TO_NAME[c]=STOCK_NAMES[i];NAME_TO_CODE[STOCK_NAMES[i]]=c;});
  renderBanknotes();
  renderCorrections();
  renderSales([]);
  $("btnAddSatisRow").onclick=()=>addRow({});
  $("kasaBakiyesi").addEventListener("input",runAllCalculations);
}

/* === PARA SAYILARI === */
function renderBanknotes(){
  const cont=$("paraSayiContainer"); cont.innerHTML="";
  const map=[
    {d:200,cell:"B4"},{d:100,cell:"B5"},{d:50,cell:"B6"},{d:20,cell:"B7"},
    {d:10,cell:"B8"},{d:5,cell:"B9"},{d:1,cell:"B10"},{d:0.5,cell:"B11"},{d:0.25,cell:"B12"}
  ];
  map.forEach(async m=>{
    const row=document.createElement("div"); row.className="para-sayi-grid";
    row.innerHTML=`<input class="form-control" value="${m.d}" readonly>
    <input id="adet_${m.cell}" class="form-control banknot-adet">
    <input class="form-control banknot-toplam" readonly>`;
    cont.appendChild(row);
    const val=await getCellValue(m.cell);
    $(`adet_${m.cell}`).value=val||"";
    $(`adet_${m.cell}`).addEventListener("input",runAllCalculations);
  });
}

/* === DÜZELTME KAYITLARI === */
function renderCorrections(){
  const cont=$("duzeltmeContainer"); cont.innerHTML="";
  for(let i=3;i<=12;i++){
    const row=document.createElement("div"); row.className="duzeltme-grid";
    row.innerHTML=`<input id="aciklama_F${i}" class="form-control duz-aciklama">
                   <input id="tutar_I${i}" class="form-control duz-tutar" type="text">`;
    cont.appendChild(row);
    getCellValue(`F${i}`).then(v=>$(`aciklama_F${i}`).value=v||"");
    getCellValue(`I${i}`).then(v=>$(`tutar_I${i}`).value=v||"");
  }
  cont.querySelectorAll(".duz-tutar").forEach(i=>i.addEventListener("input",runAllCalculations));
}

/* === Yardımcı Hücre Okuma === */
async function getCellValue(range){
  try{
    const res=await fetch(`${API}?action=getCellValue&range=${range}`);
    const data=await res.json();
    return data.value||"";
  }catch{return"";}
}

/* === SATIŞ === */
function renderSales(rows){
  const cont=$("satisKayitlariContainer"); cont.innerHTML="";
  (rows.length?rows:[{}]).forEach(r=>addRow(r));
  runAllCalculations();
}
function addRow(r={code:"",name:"",qty:"",price:"",total:""}){
  const cont=$("satisKayitlariContainer");
  const row=document.createElement("div"); row.className="satis-item-row";
  const codeSel=createSelect(STOCK_CODES,r.code);
  const nameSel=createSelect(STOCK_NAMES,r.name);
  const qty=inp("number",r.qty,"satis-qty");
  const price=inp("text",r.price,"satis-price");
  const total=inp("text",fmt(r.total||0),"satis-total"); total.readOnly=true;
  const del=btn("×","btn-remove-row");
  row.append(codeSel,nameSel,qty,price,total,del);
  cont.appendChild(row);

  const recalc=()=>{
    const q=parseTR(qty.value);
    const p=parseTR(price.value);
    total.value=fmt(q*p);
    runAllCalculations();
  };
  const updatePrice=()=>{
    clearTimeout(priceTimer);
    priceTimer=setTimeout(()=>pushPriceUpdate(codeSel.value,price.value),500);
  };
  codeSel.onchange=async()=>{
    const code=codeSel.value;nameSel.value=CODE_TO_NAME[code]||"";
    if(code){const f=await fetch(`${API}?action=findPriceByCode&code=${code}`).then(r=>r.json()).catch(()=>({}));
      price.value=f.price?f.price.toString().replace(".",","):"";
    }recalc();
  };
  nameSel.onchange=async()=>{
    const name=nameSel.value;codeSel.value=NAME_TO_CODE[name]||"";
    if(codeSel.value){const f=await fetch(`${API}?action=findPriceByCode&code=${codeSel.value}`).then(r=>r.json()).catch(()=>({}));
      price.value=f.price?f.price.toString().replace(".",","):"";
    }recalc();
  };
  qty.addEventListener("input",recalc);
  price.addEventListener("input",()=>{recalc();updatePrice();});
  del.onclick=()=>{row.remove();runAllCalculations();};
}
function createSelect(list,val){const s=document.createElement("select");s.className="form-control";s.innerHTML=`<option></option>`+list.map(v=>`<option>${v}</option>`).join("");s.value=val||"";return s;}
function inp(type,v,cls=""){const i=document.createElement("input");i.type=type;i.className=`form-control ${cls}`;i.value=v||"";return i;}
function btn(txt,cls){const b=document.createElement("button");b.textContent=txt;b.className=cls;return b;}
async function pushPriceUpdate(code,price){
 if(!code||!price)return;
 const val=price.replace(",",".");
 await fetch(`${API}?action=updatePriceByCode&code=${code}&price=${val}`).catch(()=>{});
}

/* === HESAPLAMA === */
function runAllCalculations(){
  let para=0;
  document.querySelectorAll(".para-sayi-grid").forEach(r=>{
    const d=parseTR(r.children[0].value),a=parseTR(r.children[1].value),t=d*a;
    r.children[2].value=fmt(t);para+=t;
  });
  $("paraSayilariToplam").value=fmt(para);

  let duz=0;document.querySelectorAll(".duz-tutar").forEach(i=>duz+=parseTR(i.value));
  $("duzeltmeKayitlariToplam").value=fmt(duz);

  let satisTop=0;document.querySelectorAll(".satis-total").forEach(i=>satisTop+=parseTR(i.value));
  $("nakitSatisKasaDurumu").value=fmt(satisTop);
  $("nakitSatisToplamiDuz").value=fmt(satisTop);

  const kasaTop=para+duz;
  $("kasaToplami").value=fmt(kasaTop);

  const fark=kasaTop-parseTR($("nakitSatisKasaDurumu").value)-parseTR($("kasaBakiyesi").value);
  $("kasaDurum").value=fmt(fark);
  updateKasaRenk(fark);
}
function updateKasaRenk(fark){
  const el=$("kasaDurumAciklama");el.className="kasa-durum-aciklama";
  if(fark>0){el.classList.add("kasa-fazla");el.textContent="Kasa fazla.";}
  else if(fark<0){el.classList.add("kasa-eksik");el.textContent="Kasa eksik.";}
  else{el.classList.add("kasa-tam");el.textContent="Kasa tam.";}
}

async function saveAll(){alert("Veriler güncellendi.");}
document.addEventListener("DOMContentLoaded",loadAll);
</script>
</body>
</html>
