<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PeÅŸin SatÄ±ÅŸ</title>
<style>
:root{
  --tkk-green:#1A6B3B;--tkk-orange:#FF9800;--tkk-red:#E53935;
  --tkk-white:#fff;--tkk-gray:#f5f5f5;--border:#ddd;
}
*{box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--tkk-gray);margin:0}
.container{padding:10px}
.panel{background:var(--tkk-white);border-radius:10px;box-shadow:0 0 4px rgba(0,0,0,.1);padding:15px;margin:10px;flex:1}
.panels-row{display:flex;flex-wrap:wrap;gap:10px}
h3{color:var(--tkk-green);border-bottom:2px solid var(--tkk-green);padding-bottom:4px;margin-bottom:10px}
.form-control{border:1px solid var(--border);padding:5px;border-radius:6px;width:100%}
.para-sayi-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:6px}
.duzeltme-grid{display:grid;grid-template-columns:3fr 1fr;gap:6px;margin-bottom:6px}
.duzeltme-sum-grid{display:grid;grid-template-columns:3fr 1fr;gap:6px;margin-top:10px}
.satis-item-row{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr 40px;gap:6px;align-items:center;margin-bottom:6px}
.btn-remove-row{background:var(--tkk-red);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:700}
.add-row-btn{color:var(--tkk-green);cursor:pointer;font-weight:700}
.kasa-durum-aciklama{padding:6px;color:#fff;border-radius:6px;margin-top:6px;text-align:center;font-weight:700}
.kasa-tam{background:#2E8B57}.kasa-eksik{background:#E53935}.kasa-fazla{background:#FF9800}
.btn{border:none;border-radius:8px;color:#fff;font-size:16px;font-weight:700;padding:10px 26px;cursor:pointer;transition:.2s}
.btn:hover{opacity:.9}
.btn-orange{background:var(--tkk-orange)}.btn-green{background:var(--tkk-green)}
.buttons{display:flex;justify-content:center;gap:16px;margin-top:14px}
.top-bar{background:var(--tkk-green);color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
.top-bar h2{margin:0;font-size:18px}
.top-bar button{background:#fff;color:var(--tkk-green);font-weight:700;border:none;padding:6px 14px;border-radius:6px;cursor:pointer}
.top-bar button:hover{background:#f0f0f0}
</style>
</head>
<body>
<div class="top-bar">
  <h2>PeÅŸin SatÄ±ÅŸ</h2>
  <button onclick="window.location.href='index.html'">Ana MenÃ¼ye DÃ¶n</button>
</div>

<div class="container">
  <div class="panels-row">
    <!-- PARA SAYILARI -->
    <div class="panel">
      <h3>Para SayÄ±larÄ±</h3>
      <div class="para-sayi-grid" style="font-weight:700;">
        <label>Banknot</label><label>Adet</label><label>Toplam</label>
      </div>
      <div id="paraSayiContainer"></div>
      <div class="duzeltme-sum-grid">
        <label>TOPLAM</label><input id="paraSayilariToplam" class="form-control" readonly>
      </div>
    </div>

    <!-- KASA DURUMU -->
    <div class="panel">
      <h3>Kasa Durumu</h3>
      <div class="duzeltme-sum-grid"><label>Nakit SatÄ±ÅŸ ToplamÄ±</label><input id="nakitSatisKasaDurumu" class="form-control" readonly></div>
      <div class="duzeltme-sum-grid"><label>Kasa ToplamÄ±</label><input id="kasaToplami" class="form-control" readonly></div>
      <div class="duzeltme-sum-grid"><label>Kasa Bakiyesi</label><input id="kasaBakiyesi" class="form-control"></div>
      <div class="duzeltme-sum-grid"><label>Durum</label><input id="kasaDurum" class="form-control" readonly></div>
      <label style="margin-top:8px;">AÃ§Ä±klama</label>
      <div id="kasaDurumAciklama" class="kasa-durum-aciklama kasa-tam">Kasa tam.</div>
      <div class="buttons">
        <button class="btn btn-orange" onclick="window.print()">YazdÄ±r</button>
        <button class="btn btn-green" onclick="saveAll()">Kaydet</button>
      </div>
    </div>

    <!-- DÃœZELTME KAYITLARI -->
    <div class="panel">
      <h3>DÃ¼zeltme KayÄ±tlarÄ±</h3>
      <div class="duzeltme-grid" style="font-weight:700;"><label>AÃ§Ä±klama</label><label>Tutar</label></div>
      <div id="duzeltmeContainer"></div>
      <div class="duzeltme-sum-grid"><label>DÃ¼zeltme KayÄ±tlarÄ± ToplamÄ±</label><input id="duzeltmeKayitlariToplam" class="form-control" readonly></div>
      <div class="duzeltme-sum-grid"><label>Nakit SatÄ±ÅŸ ToplamÄ±</label><input id="nakitSatisToplamiDuz" class="form-control" readonly></div>
    </div>
  </div>

  <!-- SATIÅž KAYITLARI -->
  <div class="panel" style="margin-top:12px;">
    <h3>SatÄ±ÅŸ KayÄ±tlarÄ± <span id="btnAddSatisRow" class="add-row-btn">+ SatÄ±r Ekle</span></h3>
    <div class="satis-item-row" style="font-weight:700;background:#f0f3f0;border-radius:6px;padding:6px;">
      <div>Stok Kodu</div><div>Stok AdÄ±</div><div>Miktar</div><div>Birim Fiyat</div><div>Toplam</div><div></div>
    </div>
    <div id="satisKayitlariContainer"></div>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzY7jYafKU-DuUBUqq6vj89_sLKSbCmT8c-Fen77HnxB1h7Ji7HzCZmKH8LQMZCz-04/exec";
const $=id=>document.getElementById(id);
const fmt=n=>(Number(n)||0).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2});
const parseTR=s=>{if(!s)return 0;const str=s.toString().replace(/\./g,"").replace(",",".");return parseFloat(str)||0;};

let STOCK_CODES=[],STOCK_NAMES=[],CODE_TO_NAME={},NAME_TO_CODE={},priceTimer=null;

document.addEventListener("DOMContentLoaded",init);

async function init(){
  const all=await fetch(`${API}?action=getPesinAll`).then(r=>r.json()).catch(()=>({}));
  const s=await fetch(`${API}?action=getStockLists`).then(r=>r.json()).catch(()=>({}));
  STOCK_CODES=s.codes||[];STOCK_NAMES=s.names||[];
  STOCK_CODES.forEach((c,i)=>CODE_TO_NAME[c]=STOCK_NAMES[i]);
  STOCK_NAMES.forEach((n,i)=>NAME_TO_CODE[n]=STOCK_CODES[i]);
  const r=await fetch(`${API}?action=getPesinRows`).then(r=>r.json()).catch(()=>({rows:[]}));
  renderBanknotes(all.banknotes);renderCorrections(all.corrections);renderSales(r.rows||[]);
  $("btnAddSatisRow").onclick=()=>addRow({});$("kasaBakiyesi").addEventListener("input",runAllCalculations);
  runAllCalculations();
}

/* PARA SAYILARI */
function renderBanknotes(list){
  const cont=$("paraSayiContainer");
  cont.innerHTML="";
  const denom=[200,100,50,20,10,5,1,0.5,0.25];
  denom.forEach((d,i)=>{
    const adet = Array.isArray(list) ? (list[i] ?? "") : "";
    const row=document.createElement("div");row.className="para-sayi-grid";
    row.innerHTML=`<input class="form-control" value="${d}" readonly>
                   <input class="form-control banknot-adet" value="${adet}">
                   <input class="form-control banknot-toplam" readonly>`;
    cont.appendChild(row);
  });
  cont.querySelectorAll(".banknot-adet").forEach(i=>i.addEventListener("input",runAllCalculations));
}


/* DÃœZELTME */
function renderCorrections(corr){
  const cont=$("duzeltmeContainer");cont.innerHTML="";
  const acik=corr&&corr.aciklama?corr.aciklama:[];const tut=corr&&corr.tutar?corr.tutar:[];
  for(let i=0;i<5;i++){ // ðŸ”¥ sadece 5 satÄ±r
    const row=document.createElement("div");row.className="duzeltme-grid";
    row.innerHTML=`<input class="form-control duz-aciklama" value="${acik[i]||""}">
                   <input class="form-control duz-tutar" value="${tut[i]||""}" type="text">`;
    cont.appendChild(row);
  }
  cont.querySelectorAll(".duz-tutar").forEach(i=>i.addEventListener("input",runAllCalculations));
}

/* SATIÅž */
function renderSales(rows){
  const cont=$("satisKayitlariContainer");cont.innerHTML="";
  (rows.length?rows:[{}]).forEach(r=>addRow(r));
}
function addRow(r={code:"",name:"",qty:"",price:"",total:""}){
  const cont=$("satisKayitlariContainer");
  const row=document.createElement("div");row.className="satis-item-row";
  const codeSel=createSelect(STOCK_CODES,r.code);
  const nameSel=createSelect(STOCK_NAMES,r.name);
  const qty=inp("text",r.qty?String(r.qty).replace(".",","):"","satis-qty");
  const price=inp("text",r.price?String(r.price).replace(".",","):"","satis-price");
  const total=inp("text",fmt(r.total||0),"satis-total");total.readOnly=true;
  const del=btn("Ã—","btn-remove-row");
  row.append(codeSel,nameSel,qty,price,total,del);cont.appendChild(row);

  const recalc=()=>{const q=parseTR(qty.value);const p=parseTR(price.value);total.value=fmt(q*p);runAllCalculations();};
  const updatePrice=()=>{clearTimeout(priceTimer);priceTimer=setTimeout(()=>pushPriceUpdate(codeSel.value,price.value),600);};
  codeSel.onchange=async()=>{const c=codeSel.value;nameSel.value=CODE_TO_NAME[c]||"";if(c){const f=await fetch(`${API}?action=findPriceByCode&code=${encodeURIComponent(c)}`).then(r=>r.json()).catch(()=>({}));price.value=f.price?f.price.toString().replace(".",","):"";}recalc();};
  nameSel.onchange=async()=>{const n=nameSel.value;codeSel.value=NAME_TO_CODE[n]||"";if(codeSel.value){const f=await fetch(`${API}?action=findPriceByCode&code=${encodeURIComponent(codeSel.value)}`).then(r=>r.json()).catch(()=>({}));price.value=f.price?f.price.toString().replace(".",","):"";}recalc();};
  qty.addEventListener("input",recalc);price.addEventListener("input",()=>{recalc();updatePrice();});
  del.onclick=()=>{row.remove();runAllCalculations();};
}
function createSelect(list,val){const s=document.createElement("select");s.className="form-control";s.innerHTML=`<option></option>`+list.map(v=>`<option>${v}</option>`).join("");s.value=val||"";return s;}
function inp(type,v,cls=""){const i=document.createElement("input");i.type=type;i.className=`form-control ${cls}`;i.value=v||"";return i;}
function btn(txt,cls){const b=document.createElement("button");b.textContent=txt;b.className=cls;return b;}
async function pushPriceUpdate(code,price){if(!code||!price)return;const val=price.replace(",",".");await fetch(`${API}?action=updatePriceByCode&code=${encodeURIComponent(code)}&price=${encodeURIComponent(val)}`).catch(()=>{});}

/* HESAPLAMA */
function runAllCalculations(){
  let para=0;document.querySelectorAll("#paraSayiContainer .para-sayi-grid").forEach(r=>{const d=parseTR(r.children[0].value),a=parseTR(r.children[1].value),t=d*a;r.children[2].value=fmt(t);para+=t;});
  $("paraSayilariToplam").value=fmt(para);
  let duz=0;document.querySelectorAll(".duz-tutar").forEach(i=>duz+=parseTR(i.value));$("duzeltmeKayitlariToplam").value=fmt(duz);
  let satisTop=0;document.querySelectorAll(".satis-total").forEach(i=>satisTop+=parseTR(i.value));$("nakitSatisKasaDurumu").value=fmt(satisTop);$("nakitSatisToplamiDuz").value=fmt(satisTop);
  const kasaTop=para+duz;$("kasaToplami").value=fmt(kasaTop);
  const fark=kasaTop-parseTR($("nakitSatisKasaDurumu").value)-parseTR($("kasaBakiyesi").value);$("kasaDurum").value=fmt(fark);updateKasaRenk(fark);
}
function updateKasaRenk(fark){const el=$("kasaDurumAciklama");el.className="kasa-durum-aciklama";if(fark>0){el.classList.add("kasa-fazla");el.textContent="Kasa fazla.";}else if(fark<0){el.classList.add("kasa-eksik");el.textContent="Kasa eksik.";}else{el.classList.add("kasa-tam");el.textContent="Kasa tam.";}}

/* âœ… KAYDET (GET yÃ¶ntemiyle) */
async function saveAll() {
  // --- SATIÅž KAYITLARI ---
  const rows = [];
  document.querySelectorAll("#satisKayitlariContainer .satis-item-row").forEach(r=>{
    const code=r.children[0].value||"";
    const name=r.children[1].value||"";
    const qty=parseTR(r.children[2].value);
    const price=parseTR(r.children[3].value);
    const total=qty*price;
    if(code||name||qty||price||total){rows.push({code,name,qty,price,total});}
  });
  await fetch(`${API}?action=setPesinRows&rows=${encodeURIComponent(JSON.stringify(rows))}`)
    .then(r=>r.json()).catch(()=>({}));

  // --- PARA SAYILARI ---
  const banknotes = [];
  document.querySelectorAll("#paraSayiContainer .para-sayi-grid").forEach(r=>{
    const denom=parseTR(r.children[0].value);
    const adet=parseTR(r.children[1].value);
    const toplam=denom*adet;
    banknotes.push({denom,adet,toplam});
  });
  await fetch(`${API}?action=setBanknotes&data=${encodeURIComponent(JSON.stringify(banknotes))}`);

  // --- DÃœZELTME KAYITLARI ---
  const corrections = [];
  document.querySelectorAll("#duzeltmeContainer .duzeltme-grid").forEach(r=>{
    const aciklama=r.children[0].value||"";
    const tutar=parseTR(r.children[1].value);
    if(aciklama||tutar)corrections.push({aciklama,tutar});
  });
  await fetch(`${API}?action=setCorrections&data=${encodeURIComponent(JSON.stringify(corrections))}`);

  // --- KASA DURUMU ---
  const kasaData = {
    nakitSatisToplami: parseTR($("nakitSatisKasaDurumu").value),
    kasaToplami: parseTR($("kasaToplami").value),
    kasaBakiyesi: parseTR($("kasaBakiyesi").value),
    kasaDurum: parseTR($("kasaDurum").value)
  };
  await fetch(`${API}?action=setKasaDurumu&data=${encodeURIComponent(JSON.stringify(kasaData))}`);

  alert("TÃ¼m veriler baÅŸarÄ±yla kaydedildi.");
}

</script>
</body>
</html>
