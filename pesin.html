<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DepoTech - Peşin Satış</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --green: #1A6B3B;
      --light-green: #2E8B57;
      --orange: #FF9800;
      --gray: #F5F5F5;
      --dark: #333;
    }
    body { font-family: 'Segoe UI', sans-serif; margin:0; background:var(--gray); }
    .header { background:var(--green); color:#fff; display:flex; align-items:center; justify-content:space-between; padding:10px 20px; }
    .back-button { background:#fff; color:var(--green); border:none; padding:8px 14px; border-radius:4px; font-weight:bold; cursor:pointer; }
    .container { padding:15px; }
    .top-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; }
    .panel { background:#fff; border-radius:6px; padding:12px 16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .panel-title { border-bottom:2px solid var(--light-green); padding-bottom:5px; margin-bottom:8px; color:var(--light-green); }
    .para-sayi-grid, .kasa-durum-grid, .duzeltme-grid, .satis-table-header { display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-bottom:5px; align-items:center; }
    .satis-table-header { font-weight:bold; background:#e9e9e9; padding:6px; border-radius:4px; grid-template-columns:1.2fr 2fr 1fr 1fr 1fr 40px; }
    .form-control { width:100%; padding:4px; box-sizing:border-box; border:1px solid #ccc; border-radius:3px; text-align:right; }
    .total-row label { font-weight:bold; }
    .btn { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
    .btn-primary { background:var(--green); color:white; }
    .btn-add-fis { background:none; color:var(--green); border:none; cursor:pointer; font-weight:bold; }
    .btn-add-fis i { margin-right:5px; }
    .satis-row { display:grid; grid-template-columns:1.2fr 2fr 1fr 1fr 1fr 40px; gap:5px; align-items:center; margin-top:5px; }
    .satis-row button { background:#e74c3c; color:white; border:none; border-radius:4px; cursor:pointer; }
    .kasa-buton-grup { display:flex; gap:8px; margin-top:10px; }
  </style>
</head>

<body>
  <div class="header">
    <button class="back-button" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> Ana Menü</button>
    <h1>Peşin Satış</h1>
    <div></div>
  </div>

  <div class="container">
    <div class="top-grid">
      <!-- PARA SAYILARI -->
      <div class="panel">
        <h3 class="panel-title">Para Sayıları</h3>
        <div class="para-sayi-grid" style="font-weight:bold;">
          <label>Banknot</label><label>Adet</label><label>Toplam</label>
        </div>
        <div id="paraSayiContainer"></div>
        <div class="para-sayi-grid total-row"><label>TOPLAM</label><div></div><input id="paraSayilariToplam" class="form-control" readonly></div>
      </div>

      <!-- KASA DURUMU -->
      <div class="panel">
        <h3 class="panel-title">Kasa Durumu</h3>
        <div class="kasa-durum-grid"><label>Nakit Satış Toplamı</label><input id="nakitSatisKasaDurumu" class="form-control" readonly></div>
        <div class="kasa-durum-grid"><label>Kasa Toplamı</label><input id="kasaToplami" class="form-control" readonly></div>
        <div class="kasa-durum-grid"><label>Kasa Bakiyesi</label><input type="number" id="kasaBakiyesi" class="form-control" oninput="runAllCalculations()"></div>
        <div class="kasa-durum-grid"><label>Durum</label><input id="kasaDurum" class="form-control" readonly></div>
        <div><label>Açıklama</label><div id="kasaDurumAciklama" class="form-control" style="text-align:center;color:#fff;background:#e74c3c;display:none;"></div></div>
        <div class="kasa-buton-grup">
          <button class="btn" style="background:var(--orange);color:white;"><i class="fas fa-print"></i> Yazdır</button>
          <button class="btn btn-primary"><i class="fas fa-save"></i> Kaydet</button>
        </div>
      </div>

      <!-- DÜZELTME KAYITLARI -->
      <div class="panel">
        <h3 class="panel-title">Düzeltme Kayıtları</h3>
        <div class="duzeltme-grid" style="font-weight:bold;"><label>Açıklama</label><label>Tutar</label></div>
        <div id="duzeltmeContainer"></div>
        <div class="duzeltme-grid total-row"><label>Düzeltme Kayıtları Toplamı</label><input id="duzeltmeKayitlariToplam" class="form-control" readonly></div>
        <div class="duzeltme-grid total-row"><label>Nakit Satış Toplamı</label><input id="nakitSatisDuzeltme" class="form-control" readonly></div>
      </div>
    </div>

    <!-- SATIŞ KAYITLARI -->
    <div class="panel" style="margin-top:15px;">
      <div class="satis-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h3 class="panel-title" style="margin:0;">Satış Kayıtları</h3>
        <button id="btnAddSatisRow" class="btn-add-fis"><i class="fas fa-plus"></i> Satır Ekle</button>
      </div>
      <div class="satis-table-header">
        <div>Stok Kodu</div><div>Stok Adı</div><div>Miktar</div><div>Birim Fiyat</div><div>Toplam</div><div></div>
      </div>
      <div id="satisKayitlariContainer"></div>
    </div>
  </div>

 <script>
(() => {
  "use strict";

  const API = "https://script.google.com/macros/s/AKfycbzY7jYafKU-DuUBUqq6vj89_sLKSbCmT8c-Fen77HnxB1h7Ji7HzCZmKH8LQMZCz-04/exec";

  const $ = (id) => document.getElementById(id);
  const fmt = (n) => (Number(n)||0).toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // Dropdown kaynakları
  let STOCK_CODES = [];
  let STOCK_NAMES = [];

  // ----- UI: Para Sayıları -----
  const BANKNOTE_DENOMS_ORDER = ["200","100","50","20","10","5","1","0.5","0.25","0.10","0.05","0.01"]; // gelen veri yoksa fallback

  function renderBanknoteRows(banknotes) {
    const cont = $("paraSayiContainer");
    cont.innerHTML = "";
    const byDenom = {};
    (banknotes||[]).forEach(b => { byDenom[String(b.denom)] = b; });

    const denoms = (banknotes && banknotes.length ? banknotes.map(b => String(b.denom)) : BANKNOTE_DENOMS_ORDER);

    denoms.forEach(d => {
      const row = document.createElement("div");
      row.className = "para-sayi-grid";

      const adet = byDenom[d]?.adet ?? "";
      const toplam = byDenom[d]?.toplam ?? "";

      row.innerHTML = `
        <input class="form-control banknot-denom" value="${d}" readonly>
        <input class="form-control banknot-adet" type="number" step="1" value="${adet}">
        <input class="form-control banknot-toplam" value="${toplam ? fmt(toplam) : ""}" readonly>
      `;
      cont.appendChild(row);
    });

    cont.querySelectorAll(".banknot-adet").forEach(inp => {
      inp.addEventListener("input", runAllCalculations);
    });
  }

  // ----- UI: Düzeltme Kayıtları -----
  function renderCorrectionRows(list) {
    const cont = $("duzeltmeContainer");
    cont.innerHTML = "";
    (list||[]).forEach(item => {
      const row = document.createElement("div");
      row.className = "duzeltme-grid";
      row.innerHTML = `
        <input class="form-control duzeltme-aciklama" value="${item.aciklama || ""}">
        <input class="form-control duzeltme-tutar" type="number" step="any" value="${item.tutar ?? ""}">
      `;
      cont.appendChild(row);
    });

    // en alta boş satır ekle
    const blank = document.createElement("div");
    blank.className = "duzeltme-grid";
    blank.innerHTML = `
      <input class="form-control duzeltme-aciklama" placeholder="Açıklama">
      <input class="form-control duzeltme-tutar" type="number" step="any" placeholder="0">
    `;
    cont.appendChild(blank);

    cont.querySelectorAll(".duzeltme-tutar").forEach(inp => {
      inp.addEventListener("input", runAllCalculations);
    });
  }

  // ----- UI: Satış Satırları (kod/ad select) -----
  function makeSelect(options, val) {
    const sel = document.createElement("select");
    sel.className = "form-control";
    sel.innerHTML = `<option value="">Seçiniz…</option>` + options.map(o => `<option value="${o}">${o}</option>`).join("");
    if (val) sel.value = val;
    return sel;
  }

  function addSatisRow(initial = {code:"", name:"", qty:"", price:"", total:""}) {
    const cont = $("satisKayitlariContainer");

    const row = document.createElement("div");
    row.className = "satis-item-row";

    const codeSel = makeSelect(STOCK_CODES, initial.code);
    const nameSel = makeSelect(STOCK_NAMES, initial.name);
    const qtyInp  = document.createElement("input");
    qtyInp.type = "number"; qtyInp.step = "any"; qtyInp.className = "form-control"; qtyInp.value = initial.qty ?? "";

    const priceInp = document.createElement("input");
    priceInp.type = "number"; priceInp.step = "any"; priceInp.className = "form-control"; priceInp.value = initial.price ?? "";

    const totalInp = document.createElement("input");
    totalInp.readOnly = true; totalInp.className = "form-control"; totalInp.value = initial.total ? fmt(initial.total) : "";

    const delBtn = document.createElement("button");
    delBtn.className = "btn-remove-row"; delBtn.innerHTML = "✖"; delBtn.title = "Satırı sil";

    row.append(codeSel, nameSel, qtyInp, priceInp, totalInp, delBtn);
    cont.appendChild(row);

    const recalc = () => {
      const q = Number(qtyInp.value||0);
      const p = Number(priceInp.value||0);
      totalInp.value = fmt(q*p);
      runAllCalculations(); // üst toplamları da güncelle
    };

    // Kod->Ad & Fiyat
    codeSel.addEventListener("change", async () => {
      const idx = STOCK_CODES.indexOf(codeSel.value);
      if (idx >= 0) nameSel.value = STOCK_NAMES[idx] || "";
      // fiyat çek
      if (codeSel.value) {
        const j = await fetch(`${API}?action=findPriceByCode&code=${encodeURIComponent(codeSel.value)}`, {cache:"no-store"}).then(r=>r.json()).catch(()=>null);
        const price = j?.price ?? 0;
        priceInp.value = price || "";
        recalc();
      }
    });

    // Ad->Kod & Fiyat
    nameSel.addEventListener("change", async () => {
      const idx = STOCK_NAMES.indexOf(nameSel.value);
      if (idx >= 0) codeSel.value = STOCK_CODES[idx] || "";
      if (codeSel.value) {
        const j = await fetch(`${API}?action=findPriceByCode&code=${encodeURIComponent(codeSel.value)}`, {cache:"no-store"}).then(r=>r.json()).catch(()=>null);
        const price = j?.price ?? 0;
        priceInp.value = price || "";
        recalc();
      }
    });

    qtyInp.addEventListener("input", recalc);
    priceInp.addEventListener("input", recalc);

    delBtn.addEventListener("click", () => {
      row.remove();
      runAllCalculations();
    });
  }

  // ----- HESAPLAMALAR -----
  window.runAllCalculations = function runAllCalculations() {
    // 1) Para Sayıları toplamı
    let paraToplam = 0;
    const wrap = $("paraSayiContainer");
    wrap.querySelectorAll(".para-sayi-grid").forEach(row => {
      const denom = Number(row.querySelector(".banknot-denom").value || 0);
      const adet  = Number(row.querySelector(".banknot-adet").value || 0);
      const toplam = denom * adet;
      row.querySelector(".banknot-toplam").value = toplam ? fmt(toplam) : "";
      paraToplam += toplam;
    });
    $("paraSayilariToplam").value = fmt(paraToplam);

    // 2) Düzeltme kayıtları toplamı
    let duzToplam = 0;
    $("duzeltmeContainer").querySelectorAll(".duzeltme-tutar").forEach(inp => {
      duzToplam += Number(inp.value||0);
    });
    $("duzeltmeKayitlariToplam").value = fmt(duzToplam);

    // 3) Nakit satış toplamı (düzeltme + satış kayıtları toplamından da hesaplanabilir ama şimdilik kasa panelinden okuyacağız)
    const nakitFromPanel = Number(($("nakitSatisKasaDurumu").value || "").toString().replace(/\./g,"").replace(",","."));
    const kasaToplami    = paraToplam + duzToplam;
    $("kasaToplami").value = fmt(kasaToplami);

    // 4) Kasa bakiyesi & durum
    const beklenen = nakitFromPanel || 0;
    const fark = kasaToplami - beklenen;
    $("kasaBakiyesi").value = fmt(Math.abs(fark));
    const durumInput = $("kasaDurum");
    const aciklama = $("kasaDurumAciklama");
    aciklama.style.display = "block";
    if (Math.abs(fark) < 0.005) {
      durumInput.value = "Tam";
      aciklama.className = "kasa-durum-aciklama kasa-tam";
      aciklama.textContent = "Kasa tam.";
    } else if (fark > 0) {
      durumInput.value = "Fazla";
      aciklama.className = "kasa-durum-aciklama kasa-fazla";
      aciklama.textContent = `${fmt(fark)} TL Kasa Hesabı Fazla`;
    } else {
      durumInput.value = "Eksik";
      aciklama.className = "kasa-durum-aciklama kasa-eksik";
      aciklama.textContent = `${fmt(-fark)} TL Kasa Hesabı Eksik`;
    }
  };

  // ----- YÜKLE & DOLDUR -----
  async function initPage() {
    // 1) Dropdown kaynakları
    try {
      const s = await fetch(`${API}?action=getStockLists`, {cache:"no-store"}).then(r=>r.json());
      STOCK_CODES = s?.codes || [];
      STOCK_NAMES = s?.names || [];
    } catch {}

    // 2) Para sayıları + düzeltme + kasa
    try {
      const meta = await fetch(`${API}?action=getPesinAll`, {cache:"no-store"}).then(r=>r.json());
      const banknotes   = meta?.banknotes || [];
      const corrections = meta?.corrections || [];
      const kasa        = meta?.kasa || {};

      renderBanknoteRows(banknotes);
      renderCorrectionRows(corrections);

      // Kasa alanlarını doldur
      if (typeof kasa.nakitSatisToplami === "number") $("nakitSatisKasaDurumu").value = fmt(kasa.nakitSatisToplami);
      if (typeof kasa.kasaToplami       === "number") $("kasaToplami").value          = fmt(kasa.kasaToplami);
      if (typeof kasa.kasaBakiyesi      === "number") $("kasaBakiyesi").value         = fmt(kasa.kasaBakiyesi);
      if (kasa.kasaDurum) $("kasaDurum").value = kasa.kasaDurum;

    } catch (e) {
      console.warn("getPesinAll hata:", e);
    }

    // 3) Satış satırları
    try {
      const r = await fetch(`${API}?action=getPesinRows`, {cache:"no-store"}).then(x=>x.json());
      const rows = r?.rows || [];
      // önce konteynerı temizle
      $("satisKayitlariContainer").innerHTML = "";
      // kayıtları bas
      rows.forEach(obj => addSatisRow(obj));
    } catch (e) {
      console.warn("getPesinRows hata:", e);
    }

    // 4) “Satır Ekle” butonu
    const btn = document.getElementById("btnAddSatisRow");
    if (btn) btn.addEventListener("click", () => addSatisRow({}));

    // 5) İlk hesap
    runAllCalculations();
  }

  document.addEventListener("DOMContentLoaded", initPage, { once: true });

  // Geri tuşu
  window.goBack = () => { location.href = "index.html"; };

})();
</script>
</body>
</html>
