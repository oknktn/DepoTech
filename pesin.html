<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peşin Satış</title>
<style>
:root {
  --tkk-green: #1A6B3B;
  --tkk-light-green: #2E8B57;
  --tkk-orange: #FF9800;
  --tkk-red: #E53935;
  --tkk-white: #FFFFFF;
  --tkk-light-gray: #F5F5F5;
  --tkk-dark-gray: #333333;
  --tkk-border: #ddd;
}
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: var(--tkk-light-gray);
  margin: 0;
  padding: 0;
}
.container { padding: 10px; }

/* === PANEL GENEL === */
.panel {
  background: var(--tkk-white);
  border-radius: 10px;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
  padding: 15px;
  margin: 10px;
  flex: 1;
}
.panels-row { display: flex; flex-wrap: wrap; gap: 10px; }
h3 {
  color: var(--tkk-green);
  border-bottom: 2px solid var(--tkk-green);
  padding-bottom: 4px;
  margin-bottom: 10px;
}

/* === PARA SAYILARI === */
.para-sayi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 5px; }
.form-control {
  border: 1px solid var(--tkk-border);
  padding: 4px;
  border-radius: 5px;
  width: 100%;
  box-sizing: border-box;
}
#paraSayilariToplam { font-weight: bold; background: #fff8e1; }

/* === DÜZELTME === */
.duzeltme-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 5px; margin-bottom: 5px; }

/* === SATIŞ KAYITLARI === */
.satis-item-row {
  display: grid;
  grid-template-columns: 1fr 2fr 1fr 1fr 1fr 40px;
  gap: 5px;
  align-items: center;
  margin-bottom: 5px;
}
.btn-remove-row {
  background: var(--tkk-red);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}
.btn-remove-row:hover { opacity: 0.8; }
.add-row-btn { color: var(--tkk-green); cursor: pointer; font-weight: bold; }

/* === KASA DURUMU === */
.kasa-durum-aciklama {
  padding: 6px;
  color: white;
  border-radius: 5px;
  margin-top: 5px;
  text-align: center;
  font-weight: bold;
}
.kasa-tam { background: #2E8B57; }
.kasa-eksik { background: #E53935; }
.kasa-fazla { background: #FF9800; }

/* === BUTONLAR === */
.btn {
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  font-weight: bold;
  padding: 10px 25px;
  cursor: pointer;
  transition: 0.2s;
}
.btn:hover { opacity: 0.9; }
.btn-orange { background: var(--tkk-orange); }
.btn-green { background: var(--tkk-green); }
.buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
}
</style>
</head>
<body>
<div class="container">

  <div class="panels-row">
    <!-- === PARA SAYILARI === -->
    <div class="panel" style="flex:1">
      <h3>Para Sayıları</h3>
      <div id="paraSayiContainer"></div>
      <div style="margin-top:8px;">
        <label>TOPLAM</label>
        <input id="paraSayilariToplam" class="form-control" readonly>
      </div>
    </div>

    <!-- === KASA DURUMU === -->
    <div class="panel" style="flex:1">
      <h3>Kasa Durumu</h3>
      <label>Nakit Satış Toplamı</label>
      <input id="nakitSatisKasaDurumu" class="form-control">
      <label>Kasa Toplamı</label>
      <input id="kasaToplami" class="form-control">
      <label>Kasa Bakiyesi</label>
      <input id="kasaBakiyesi" class="form-control">
      <label>Durum</label>
      <input id="kasaDurum" class="form-control">
      <label>Açıklama</label>
      <div id="kasaDurumAciklama" class="kasa-durum-aciklama kasa-tam">Kasa tam.</div>
      <div class="buttons">
        <button class="btn btn-orange">Yazdır</button>
        <button class="btn btn-green">Kaydet</button>
      </div>
    </div>

    <!-- === DÜZELTME === -->
    <div class="panel" style="flex:1">
      <h3>Düzeltme Kayıtları</h3>
      <div id="duzeltmeContainer"></div>
      <div>
        <label>Düzeltme Kayıtları Toplamı</label>
        <input id="duzeltmeKayitlariToplam" class="form-control" readonly>
      </div>
    </div>
  </div>

  <!-- === SATIŞ KAYITLARI === -->
  <div class="panel" style="margin-top:15px;">
    <h3>Satış Kayıtları <span class="add-row-btn" id="btnAddSatisRow">+ Satır Ekle</span></h3>
    <div id="satisKayitlariContainer"></div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzY7jYafKU-DuUBUqq6vj89_sLKSbCmT8c-Fen77HnxB1h7Ji7HzCZmKH8LQMZCz-04/exec";
const $ = id => document.getElementById(id);
const fmt = n => (Number(n)||0).toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
let STOCK_CODES=[], STOCK_NAMES=[];

async function loadAll() {
  const s = await fetch(`${API}?action=getStockLists`).then(r=>r.json()).catch(()=>({}));
  STOCK_CODES = s.codes||[]; STOCK_NAMES = s.names||[];

  const a = await fetch(`${API}?action=getPesinAll`).then(r=>r.json()).catch(()=>({}));
  const b = await fetch(`${API}?action=getPesinRows`).then(r=>r.json()).catch(()=>({}));

  renderBanknotes(a.banknotes||[]);
  renderCorrections(a.corrections||[]);
  fillKasa(a.kasa||{});
  renderSales(b.rows||[]);
}

function renderBanknotes(data){
  const cont=$("paraSayiContainer");
  const denoms=["200","100","50","20","10","5","1","0.5","0.25","0.10","0.05","0.01"];
  cont.innerHTML="";
  denoms.forEach(d=>{
    const row=document.createElement("div");
    row.className="para-sayi-grid";
    const adet=data.find(x=>String(x.denom)==d)?.adet||"";
    const toplam=data.find(x=>String(x.denom)==d)?.toplam||"";
    row.innerHTML=`<input class="form-control" value="${d}" readonly>
    <input class="form-control banknot-adet" value="${adet}">
    <input class="form-control banknot-toplam" value="${fmt(toplam)}" readonly>`;
    cont.appendChild(row);
  });
  cont.querySelectorAll(".banknot-adet").forEach(inp=>inp.oninput=runAllCalculations);
}

function renderCorrections(data){
  const cont=$("duzeltmeContainer"); cont.innerHTML="";
  for(let i=0;i<10;i++){
    const a=data[i]?.aciklama||"", t=data[i]?.tutar||"";
    const row=document.createElement("div");
    row.className="duzeltme-grid";
    row.innerHTML=`<input class="form-control duzeltme-aciklama" value="${a}">
                   <input class="form-control duzeltme-tutar" type="number" value="${t}">`;
    cont.appendChild(row);
  }
  cont.querySelectorAll(".duzeltme-tutar").forEach(inp=>inp.oninput=runAllCalculations);
}

function fillKasa(k){
  $("nakitSatisKasaDurumu").value = fmt(k.nakitSatisToplami||0);
  $("kasaToplami").value = fmt(k.kasaToplami||0);
  $("kasaBakiyesi").value = fmt(k.kasaBakiyesi||0);
  $("kasaDurum").value = k.kasaDurum||"Tam";
  updateKasaRenk(k.kasaDurum||"Tam");
}
function updateKasaRenk(durum){
  const el=$("kasaDurumAciklama");
  el.className="kasa-durum-aciklama";
  if(durum==="Tam") el.classList.add("kasa-tam"), el.textContent="Kasa tam.";
  else if(durum==="Eksik") el.classList.add("kasa-eksik"), el.textContent="Kasa hesabı eksik.";
  else if(durum==="Fazla") el.classList.add("kasa-fazla"), el.textContent="Kasa hesabı fazla.";
}

function renderSales(rows){
  const cont=$("satisKayitlariContainer"); cont.innerHTML="";
  rows.forEach(r=>addRow(r));
}
function addRow(r={code:"",name:"",qty:"",price:"",total:""}){
  const cont=$("satisKayitlariContainer");
  const row=document.createElement("div"); row.className="satis-item-row";
  const codeSel=select(STOCK_CODES,r.code), nameSel=select(STOCK_NAMES,r.name);
  const qty=inp("number",r.qty), price=inp("number",r.price), total=inp("",fmt(r.total));
  total.readOnly=true;
  const del=btn("x","btn-remove-row");
  row.append(codeSel,nameSel,qty,price,total,del);
  cont.appendChild(row);

  codeSel.onchange=async()=>{
    const i=STOCK_CODES.indexOf(codeSel.value);
    if(i>=0) nameSel.value=STOCK_NAMES[i]||"";
    const f=await fetch(`${API}?action=findPriceByCode&code=${codeSel.value}`).then(r=>r.json()).catch(()=>({}));
    price.value=f.price||"";
    calc();
  };
  nameSel.onchange=async()=>{
    const i=STOCK_NAMES.indexOf(nameSel.value);
    if(i>=0) codeSel.value=STOCK_CODES[i]||"";
    const f=await fetch(`${API}?action=findPriceByCode&code=${codeSel.value}`).then(r=>r.json()).catch(()=>({}));
    price.value=f.price||"";
    calc();
  };
  qty.oninput=calc; price.oninput=calc;
  del.onclick=()=>{row.remove(); runAllCalculations();};
  function calc(){ total.value=fmt((+qty.value||0)*(+price.value||0)); runAllCalculations(); }
}
function select(opts,val){const s=document.createElement("select"); s.className="form-control"; s.innerHTML=`<option></option>`+opts.map(o=>`<option>${o}</option>`).join(""); s.value=val; return s;}
function inp(type,v){const i=document.createElement("input"); i.className="form-control"; if(type)i.type=type; i.value=v; return i;}
function btn(txt,cls){const b=document.createElement("button"); b.textContent=txt; b.className=cls; return b;}

function runAllCalculations(){
  let para=0;
  document.querySelectorAll(".para-sayi-grid").forEach(r=>{
    const d=+r.children[0].value, a=+r.children[1].value; 
    const t=d*a; r.children[2].value=fmt(t); para+=t;
  });
  $("paraSayilariToplam").value=fmt(para);
  let duz=0; document.querySelectorAll(".duzeltme-tutar").forEach(i=>duz+=+i.value||0);
  $("duzeltmeKayitlariToplam").value=fmt(duz);
  const nakit=+$("nakitSatisKasaDurumu").value.replace(/\./g,"").replace(",","."), kasatop=para+duz;
  $("kasaToplami").value=fmt(kasatop);
  const fark=kasatop-nakit;
  $("kasaBakiyesi").value=fmt(Math.abs(fark));
  const durum = fark>0?"Fazla":fark<0?"Eksik":"Tam";
  $("kasaDurum").value=durum;
  updateKasaRenk(durum);
}
document.addEventListener("DOMContentLoaded",loadAll);
</script>
</body>
</html>
