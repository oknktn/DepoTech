<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Peşin Satış</title>
<style>
:root{
--tkk-green:#1A6B3B;--tkk-orange:#FF9800;--tkk-red:#E53935;--tkk-white:#fff;--tkk-gray:#f5f5f5;--border:#ddd;
}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--tkk-gray);margin:0}
.container{padding:10px}
.panel{background:var(--tkk-white);border-radius:10px;box-shadow:0 0 4px rgba(0,0,0,.1);padding:15px;margin:10px;flex:1}
.panels-row{display:flex;flex-wrap:wrap;gap:10px}
h3{color:var(--tkk-green);border-bottom:2px solid var(--tkk-green);padding-bottom:4px;margin-bottom:10px}
.form-control{border:1px solid var(--border);padding:5px;border-radius:6px;width:100%;box-sizing:border-box}
.para-sayi-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:6px}
.duzeltme-grid{display:grid;grid-template-columns:3fr 1fr;gap:6px;margin-bottom:6px}
.duzeltme-sum-grid{display:grid;grid-template-columns:3fr 1fr;gap:6px;margin-top:10px}
.satis-item-row{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr 40px;gap:6px;align-items:center;margin-bottom:6px}
.btn-remove-row{background:var(--tkk-red);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:700}
.add-row-btn{color:var(--tkk-green);cursor:pointer;font-weight:700}
.kasa-durum-aciklama{padding:6px;color:#fff;border-radius:6px;margin-top:6px;text-align:center;font-weight:700}
.kasa-tam{background:#2E8B57}.kasa-eksik{background:#E53935}.kasa-fazla{background:#FF9800}
.btn{border:none;border-radius:8px;color:#fff;font-size:16px;font-weight:700;padding:10px 26px;cursor:pointer;transition:.2s}
.btn:hover{opacity:.9}
.btn-orange{background:var(--tkk-orange)}.btn-green{background:var(--tkk-green)}
.buttons{display:flex;justify-content:center;gap:16px;margin-top:14px}
</style>
</head>
<body>
<div class="container">

  <div class="panels-row">
    <div class="panel">
      <h3>Para Sayıları</h3>
      <div id="paraSayiContainer"></div>
      <div class="duzeltme-sum-grid">
        <label>TOPLAM</label><input id="paraSayilariToplam" class="form-control" readonly>
      </div>
    </div>

    <div class="panel">
      <h3>Kasa Durumu</h3>
      <label>Nakit Satış Toplamı</label>
      <input id="nakitSatisKasaDurumu" class="form-control" readonly>
      <label>Kasa Toplamı</label>
      <input id="kasaToplami" class="form-control" readonly>
      <label>Kasa Bakiyesi</label>
      <input id="kasaBakiyesi" class="form-control">
      <label>Durum</label>
      <input id="kasaDurum" class="form-control" readonly>
      <div id="kasaDurumAciklama" class="kasa-durum-aciklama kasa-tam">Kasa tam.</div>
      <div class="buttons">
        <button class="btn btn-orange" onclick="window.print()">Yazdır</button>
        <button class="btn btn-green" onclick="saveAll()">Kaydet</button>
      </div>
    </div>

    <div class="panel">
      <h3>Düzeltme Kayıtları</h3>
      <div id="duzeltmeContainer"></div>
      <div class="duzeltme-sum-grid">
        <label>Düzeltme Kayıtları Toplamı</label>
        <input id="duzeltmeKayitlariToplam" class="form-control" readonly>
      </div>
      <div class="duzeltme-sum-grid">
        <label>Nakit Satış Toplamı</label>
        <input id="nakitSatisToplamiDuz" class="form-control" readonly>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <h3>Satış Kayıtları <span id="btnAddSatisRow" class="add-row-btn">+ Satır Ekle</span></h3>
    <div id="satisKayitlariContainer"></div>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzY7jYafKU-DuUBUqq6vj89_sLKSbCmT8c-Fen77HnxB1h7Ji7HzCZmKH8LQMZCz-04/exec";
const $=id=>document.getElementById(id);
const fmt=n=>(Number(n)||0).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2});
const parseTR=s=>{if(!s)return 0;const x=s.toString().trim().replace(/\./g,"").replace(",",".");const n=Number(x);return isNaN(n)?0:n;}
let STOCK_CODES=[],STOCK_NAMES=[],CODE_TO_NAME={},NAME_TO_CODE={};

async function loadAll(){
  const s=await fetch(`${API}?action=getStockLists`).then(r=>r.json()).catch(()=>({}));
  STOCK_CODES=s.codes||[];STOCK_NAMES=s.names||[];
  for(let i=0;i<STOCK_CODES.length;i++){CODE_TO_NAME[STOCK_CODES[i]]=STOCK_NAMES[i];NAME_TO_CODE[STOCK_NAMES[i]]=STOCK_CODES[i];}

  const all=await fetch(`${API}?action=getPesinAll`).then(r=>r.json()).catch(()=>({}));
  const rows=await fetch(`${API}?action=getPesinRows`).then(r=>r.json()).catch(()=>({}));

  renderBanknotes(all.banknotes||[]);
  renderCorrections(all.corrections||[]);
  fillKasa(all.kasa||{});
  renderSales(rows.rows||[]);
  $("btnAddSatisRow").onclick=()=>addRow({});
}

/* === Para Sayıları === */
function renderBanknotes(data){
  const cont=$("paraSayiContainer"); cont.innerHTML="";
  const denoms=["200","100","50","20","10","5","1","0.5","0.25","0.10","0.05","0.01"];
  denoms.forEach(d=>{
    const rec=data.find(x=>String(x.denom)==d)||{};
    const row=document.createElement("div"); row.className="para-sayi-grid";
    row.innerHTML=`<input class="form-control" value="${d}" readonly>
    <input class="form-control banknot-adet" value="${rec.adet||''}">
    <input class="form-control banknot-toplam" value="${fmt(rec.toplam||0)}" readonly>`;
    cont.appendChild(row);
  });
  cont.querySelectorAll(".banknot-adet").forEach(i=>i.oninput=runAllCalculations);
}

/* === Düzeltme Kayıtları === */
function renderCorrections(data){
  const cont=$("duzeltmeContainer"); cont.innerHTML="";
  for(let i=0;i<10;i++){
    const a=data[i]?.aciklama||"",t=data[i]?.tutar||"";
    const row=document.createElement("div"); row.className="duzeltme-grid";
    row.innerHTML=`<input class="form-control duz-aciklama" value="${a}">
    <input class="form-control duz-tutar" type="number" value="${t}">`;
    cont.appendChild(row);
  }
  cont.querySelectorAll(".duz-tutar").forEach(i=>i.oninput=runAllCalculations);
}

/* === Kasa Durumu === */
function fillKasa(k){
  $("nakitSatisKasaDurumu").value=fmt(k.nakitSatisToplami||0);
  $("kasaToplami").value=fmt(k.kasaToplami||0);
  $("kasaBakiyesi").value="";
  $("kasaDurum").value="Tam";
  updateKasaRenk("Tam");
}
function updateKasaRenk(durum){
  const el=$("kasaDurumAciklama"); el.className="kasa-durum-aciklama";
  if(durum==="Tam")el.classList.add("kasa-tam"),el.textContent="Kasa tam.";
  else if(durum==="Eksik")el.classList.add("kasa-eksik"),el.textContent="Kasa hesabı eksik.";
  else el.classList.add("kasa-fazla"),el.textContent="Kasa hesabı fazla.";
}

/* === Satış === */
function renderSales(rows){
  const cont=$("satisKayitlariContainer"); cont.innerHTML="";
  if(!rows.length) rows=[{}];
  rows.forEach(r=>addRow(r));
  runAllCalculations();
}
function addRow(r={code:"",name:"",qty:"",price:"",total:""}){
  const cont=$("satisKayitlariContainer");
  const row=document.createElement("div"); row.className="satis-item-row";
  const codeSel=createSelect(STOCK_CODES,r.code);
  const nameSel=createSelect(STOCK_NAMES,r.name);
  const qty=inp("number",r.qty,"satis-qty");
  const price=inp("number",r.price,"satis-price");
  const total=inp("",fmt(r.total||0),"satis-total"); total.readOnly=true;
  const del=btn("×","btn-remove-row");
  row.append(codeSel,nameSel,qty,price,total,del);
  cont.appendChild(row);

  codeSel.onchange=async()=>{
    const code=(codeSel.value||"").trim();
    nameSel.value=CODE_TO_NAME[code]||"";
    if(code){
      const f=await fetch(`${API}?action=findPriceByCode&code=${code}`).then(r=>r.json()).catch(()=>({}));
      price.value=f.price||"";
    }
    perRowCalc();
  };
  nameSel.onchange=async()=>{
    const name=(nameSel.value||"").trim();
    codeSel.value=NAME_TO_CODE[name]||"";
    if(codeSel.value){
      const f=await fetch(`${API}?action=findPriceByCode&code=${codeSel.value}`).then(r=>r.json()).catch(()=>({}));
      price.value=f.price||"";
    }
    perRowCalc();
  };
  qty.oninput=perRowCalc;
  price.oninput=()=>{perRowCalc();pushPriceUpdate(codeSel.value,price.value);};
  del.onclick=()=>{row.remove();runAllCalculations();};
  function perRowCalc(){
    const t=parseTR(qty.value)*parseTR(price.value);
    total.value=fmt(t); runAllCalculations();
  }
}
function createSelect(opts,val){
  const s=document.createElement("select"); s.className="form-control";
  s.innerHTML=`<option></option>`+opts.map(o=>`<option value="${o}">${o}</option>`).join("");
  s.value=val||""; return s;
}
function inp(type,v,cls=""){const i=document.createElement("input");if(type)i.type=type;i.className=`form-control ${cls}`;i.value=v||"";return i;}
function btn(txt,cls){const b=document.createElement("button");b.textContent=txt;b.className=cls;return b;}
async function pushPriceUpdate(code,price){
  if(!code||!price)return;
  await fetch(`${API}?action=updatePriceByCode&code=${code}&price=${price}`).catch(()=>{});
}

/* === Hesaplamalar === */
function runAllCalculations(){
  let para=0;document.querySelectorAll(".para-sayi-grid").forEach(r=>{
    const d=parseTR(r.children[0].value),a=parseTR(r.children[1].value),t=d*a;
    r.children[2].value=fmt(t);para+=t;
  });$("paraSayilariToplam").value=fmt(para);

  let duz=0;document.querySelectorAll(".duz-tutar").forEach(i=>duz+=parseTR(i.value));
  $("duzeltmeKayitlariToplam").value=fmt(duz);

  let satisTop=0;document.querySelectorAll(".satis-total").forEach(i=>satisTop+=parseTR(i.value));
  $("nakitSatisToplamiDuz").value=fmt(satisTop);
  $("nakitSatisKasaDurumu").value=fmt(satisTop);

  const kasaTop=para+duz;
  $("kasaToplami").value=fmt(kasaTop);

  const fark=kasaTop-(satisTop+parseTR($("kasaBakiyesi").value));
  const durum=fark>0?"Fazla":fark<0?"Eksik":"Tam";
  $("kasaDurum").value=durum;
  updateKasaRenk(durum);
}

async function saveAll(){alert("Tüm hesaplamalar tamam. Kaydetme işlemleri eklenebilir.")}
document.addEventListener("DOMContentLoaded",loadAll);
</script>
</body>
</html>
